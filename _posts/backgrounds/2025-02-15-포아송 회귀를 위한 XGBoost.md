---
title: 포아송 회귀를 위한 XGBoost
date: 2025-02-15 00:00:00 +09:00
categories: [backgrounds]
math: true
---

> 본 글에서는 XGBoost의 objective function 중 하나인 `count:poisson`에 대해 다룹니다.  
> 특히 **간헐적 수요(intermittent demand)**, **0-inflated 데이터**, **비대칭적 손실 구조**를 가진 e-commerce 수요 데이터에서 왜 Poisson 목적함수가 효과적인지를 설명합니다.

---

## 1. 기본 개념: Poisson 분포 기반 회귀

`count:poisson`은 XGBoost에서 **이산적 사건 빈도(count data)** 를 예측하기 위한 목적함수입니다. 

이는 목표변수 $ y_i $가 음이 아닌 정수(non-negative integer)이며, Poisson 분포를 따른다고 가정합니다.

$$
P(Y = y_i | \lambda_i) = \frac{e^{-\lambda_i} \lambda_i^{y_i}}{y_i!}
$$

여기서 $ \lambda_i = \exp(\mathbf{x}_i^\top \mathbf{w}) $ 는 예측값의 평균이자 분산을 의미합니다. <br>
즉, 예측값이 항상 양수이며, 데이터가 희소하거나 0이 많은 경우에도 안정적인 모델링이 가능합니다.

---
## 2. 손실 함수와 그래디언트

XGBoost의 `count:poisson` 목적함수는 다음과 같은 음의 로그우도(Negative Log-Likelihood)를 최소화합니다.

$$
\mathcal{L} = -\sum_i \left( y_i \log(\lambda_i) - \lambda_i - \log(y_i!) \right)
$$

이를 예측값 $ \hat{y}_i = \log(\lambda_i) $ 에 대해 미분하면 : 

$$
g_i = \exp(\hat{y}_i) - y_i, \quad
h_i = \exp(\hat{y}_i)
$$

여기서 $ g_i $는 1차 미분(gradient), $ h_i $는 2차 미분(hessian)에 해당합니다.

---
## 3. 비대칭 손실 문제(Underprediction Bias)에 대한 부분적 대응

일반적인 회귀 모델의 손실함수(MSE, MAE)는 예측이 실제보다 크거나 작을 때 동일한 페널티를 부여하는 **대칭적 구조(symmetric loss)** 를 가집니다.  

하지만 수요예측 문제에서는 이러한 손실함수를 사용할 수 있는 데이터가 제한적입니다. 대부분이 롱테일 상품이기 때문입니다.

- **과소예측(underprediction)** -> 품절, 매출 손실 등 실질적 비용이 큼
- **과대예측(overprediction)** -> 재고 비용 증가이지만 상대적으로 완만한 손실

즉, 실제 운영 환경에서는 **"과소예측의 비용이 더 크다"** 는 비대칭적 손실 구조가 필요합니다.

---

### 3.1 count:poisson 목적함수의 구조적 비대칭성

`count:poisson`은 이러한 상황에 자연스럽게 대응합니다.  

앞서 도출한 미분식을 보면 : 

$$
g_i = \exp(\hat{y}_i) - y_i, \quad h_i = \exp(\hat{y}_i)
$$

이를 해석하면 다음과 같습니다.

1. **예측이 작을 때 (과소예측)**
  - $ \exp(\hat{y}_i) \ll y_i $ 이므로 $ g_i $는 큰 음수 -> 모델이 **상향 조정(upward correction)** 하도록 강하게 학습
  - 즉, 수요를 낮게 본 경우 빠르게 상향 보정되는 경향이 있음

2. **예측이 클 때 (과대예측)**
  - $ \exp(\hat{y}_i) $ 가 커지면 $ h_i = \exp(\hat{y}_i) $ 도 커져 gradient의 효과가 완화(down-weighted)됨 -> 과대예측 시에는 완만한 수정만 이루어짐

이 구조로 인해 `count:poisson`은 손실함수 자체가 **"과소예측에는 민감하게, 과대예측에는 완만하게"** 반응하는 **비대칭적 경사 압력(asymmetric gradient pressure)** 을 내포합니다.

물론, 실제 데이터에서도 이렇게.. 이상적으로 작동할지는 미지수입니다. ^ㅡ^...

---

### 3.2 실무적 해석(...기대!)
> **요약**  <br>
> `count:poisson`은 수학적으로는 로그우도 기반 손실이지만, 실질적으로는 **“과소예측에 더 민감한 비대칭 회귀 목적함수”** 로 작동합니다.

이러한 비대칭성 덕분에 `count:poisson` 목적함수는 다음과 같은 상황에서 장점을 보일 것으로 생각합니다.

| 상황 | 일반 RMSE / MAE 기반 모델 | count:poisson |
|------|-----------------------------|----------------|
| 수요 폭증 이벤트 직후 | 예측이 낮아도 천천히 상향 조정 | 급격히 상향 조정 |
| 품목별 수요 분산이 큰 경우 | 평균적 예측으로 수렴 | 고수요 구간에 더 빠르게 반응 |
| 0-inflated 데이터 | 0 근처 예측에서 불안정 | 0은 유지하되 양수 발생 시 빠르게 상승 |

`count:poisson`은 수요 분포가 한쪽으로 치우쳐 있거나 "재고 부족이 곧 손실"인 상황에서 유용할 것으로 보입니다. 

**과소예측 리스크를 줄이는 방향으로 학습이 진행** 되리라 예상되기 때문입니다.

---

## 4. E-commerce 수요예측에서의 활용

전자상거래 환경에서의 수요는 대체로 다음의 특징을 가집니다:
- 대부분의 SKU는 일 단위 판매가 0이거나 매우 작음 (intermittent demand)
- 특정 이벤트 기간에 수요가 급격히 증가
- 예측 실패 시 과소예측의 리스크가 훨씬 큼

위와 같은 데이터 특성에서 목적함수를 변경한 XGBoost를 활용한다고 가정하면, 다음의 장단점이 예상됩니다.

- **장점**
  - 음수 예측을 자연스럽게 방지 ($ \lambda_i > 0 $)
  - 수요가 '발생 횟수' 형태로 분포할 때 적합
  - 과소예측 방지에 유리 (λ는 log-scale에서 제한되지 않음)

- **단점**
  - 분산이 평균과 동일하다는 가정(등분산성)이 필요한데, 실제 데이터에서는 성립되지 않는 경우가 많을 것임
  - Zero-inflation이 극단적인 경우에는 **Zero-Inflated Poisson (ZIP)** 모델이 더 적합할 수 있다고 함


---

## 5. 요약

| 항목 | 설명 |
|------|------|
| 목적함수 | count:poisson |
| 예측 대상 | 음이 아닌 정수형 수요량 |
| 가정 | $E[Y]=Var[Y]=\lambda$ |
| 장점 | 비음수 제약, 과소예측 완화, event-driven 수요에 민감 |
| 단점 | Zero-inflation이 극단적일 경우 ZIP(ZIPoisson) 필요 |
