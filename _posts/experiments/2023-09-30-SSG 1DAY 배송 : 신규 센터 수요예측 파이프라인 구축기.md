---
title: SSG 1DAY 배송 - 신규 센터 수요예측 파이프라인 구축기
date: 2023-09-30 00:00:00 +09:00
categories: [experiments]
math: true
---
> **한 줄 요약**  
> - 데이터가 부족한 신규 센터(RDC 동탄센터)의 *cold-start* 상황에서 이동평균(Baseline) 기반 수요예측 파이프라인을 구축한 내용을 다룹니다.  
> - 데이터가 추가됨에 따라 **Long-tail SKU를 위한 Rule-based 이동평균**으로 개선하며, 서비스 대상 SKU 커버리지를 확장했습니다. 
> - 자동발주 예측 파이프라인을 **Scala/Spark + Mesos + Azkaban**으로 배포했습니다.

참고: [SSG 1DAY 배송 서비스 소개 (신세계그룹 뉴스룸)](https://www.shinsegaegroupnewsroom.com/108362/)

---

## 1. 배경과 목표

<img src="/assets/img/ssg-1day-delivery.png" width="500px" height="500px" alt="ssg 1day"> 

- SSG 1DAY 배송 서비스를 위해, RDC동탄센터를 신규 가동하게 되었습니다. 
- 신규 오픈 센터는 과거 데이터가 부족하여 ML 모델 적용(학습)이 어렵고, 서비스 정책 정합성 이슈가 잦습니다.

본 프로젝트(2023.07~09)의 1차 목표는:

1) **RDC 동탄** 자동발주용 **기초 수요예측 파이프라인** 단기 가동
2) **배송유형상세코드** 등 정책 컬럼 정비로 **SSG 1DAY 대상 SKU 커버리지 확대**
3) **30일 평균 출하량 기반의 헤드/롱테일 분리(Top20/Bottom80)** 와 **상품판매운영시간 가중 이동평균**으로 초기 성능 개선

---

## 2. 타임라인 및 주요 성과

| 시기 | 주제 | 접근 방식 | 성과                            | 기술 스택 |
|------|------|-----------|-------------------------------|-----------|
| 2023.07 | 신규 센터 초기 모델 | 30일 이동평균(sell_oper_time 가중) | 자동발주 예측 서비스 오픈                | Scala, Spark, Mesos, Azkaban |
| 2023.08 | SKU 커버리지 확장 | 배송유형상세코드 정합성 개선 | 커버리지 **+14%**                 | Scala, Spark |
| 2023.09 | 헤드/롱테일 분리 | **30일 평균 출하량 Top20/Bottom80** 분기 + 룰 보정 | **MPE 약 20% 개선(–18% → –14%)** | Scala, Spark, Mesos, Azkaban |

> (참고) MPE 개선치는 당시 내부 결과를 바탕으로 재구성한 추정치입니다. 품목군/주차별 차이가 존재합니다.

---

## 3. 데이터 스키마(요약)

| 구분 | 컬럼명                                    | 설명 |
|------|----------------------------------------|------|
| key | `str_no`, `sku_id`, `calday`           | 센터, SKU, 날짜 |
| target | `y`                                    | 일출하량 |
| feature | `sell_oper_time`                       | 판매 운영시간(시간) |
| policy | `dlv_type_dtl_cd`, `ssg_1day_eligible` | 배송 정책 기준 |
| meta | `is_holiday`, `dow`                    | 휴일, 요일 |

> (참고) 컬럼명은 블로그 발행을 위해 재구성 했습니다.
---
## 4. 모델링 전략

### 4.1 헤드/롱테일 분리 (30일 평균 출하량 기준)

- 각 센터 내 SKU의 **30일 평균 출하량** \(\overline{y}_{30}\) 계산
- 센터별 상위 20%를 **헤드(Head)**, 나머지 80%를 **롱테일(Long-tail)** 로 태깅
  - 헤드: $ (\overline{y}_{30} \ge \text{p80}(\overline{y}_{30} \mid \text{center}) $
  - 롱테일: $ otherwise $ 

### 4.2 예측 로직

- **운영시간 가중 이동평균 (공통 기반)**  
  $$
  \hat{y}_{t+1}=\frac{\sum_{i=0}^{W-1} y_{t-i}\cdot w_{t-i}}{\sum_{i=0}^{W-1} w_{t-i}}, \quad
  w_{t-i}=\max(sell\_oper\_time_{t-i}, \epsilon)
  $$

- **헤드(Top20%)**: 운영시간 가중 이동평균 그대로 사용 (충분한 관측치)
- **롱테일(Bottom80%)**:
  1) **양수일만 가중** 이동평균(희박 관측치 노이즈 완화)
  2) 최근 양수일 **중앙값(median)** 과 **0.7:0.3 블렌딩**
  3) 연속 무판매 구간이 길면 **소폭 수축(shrink)**

---

## 5. 파이프라인 의사코드

```text
[Daily Batch for target_date T]

1) 로드
   S = load_sales(T - lookback ... T-1)
   P = load_policy_map(T)

2) 정책 필터
   S' = S ⋈ P
        where ssg_1day_eligible = true

3) 30일 평균 출하량 계산
   Y30 = avg_y_30(center, sku) over [T-30, T-1]

4) 센터별 p80 계산 & 헤드/롱테일 태깅
   TH = percentile(Y30 by center, 0.80)
   tag = if Y30 >= TH then "head" else "longtail"

5) 예측
   if tag == "head":
       yhat = weighted_MA(all_days, weights=sell_oper_time)
   else:
       yhat_pos = weighted_MA(positive_days, weights=sell_oper_time)
       med_pos  = recent_positive_median()
       yhat = 0.7*yhat_pos + 0.3*med_pos
       yhat = shrink_if_long_no_sale(yhat)

6) 저장/배포
   save_forecast(center, sku, T, yhat)
   publish_to_ordering_system()
```

## 6. 회고
### 6.1 운영 상 교훈
- 정책 컬럼 고정이 다른 무엇보다도 먼저: 데이터 정합성(배송유형상세코드)이 커버리지와 성능을 동시에 끌어올림
- sell_oper_time 가중의 단순 + 확실한 이득: 운영시간 변동성 큰 서비스에서 기본 방어막이 될 수 있음
- 헤드/롱테일 분기만으로도 체감 성능 개선: 파이프라인 복잡도 대비 효익이 큼
- 단, 지표는 방향성과 규모를 함께: MPE(방향성) + SMAPE/nMAE(규모) 병행 모니터링

### 6.2 다음 단계
- 데이터, 정책 안정화 이후 ML 전환(2023 하반기 또는 2024 상반기 예정)
