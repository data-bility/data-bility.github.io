---
title: 입하 최대용량(CAPA)을 고려한 자동발주취소 Rank 모델 개발
date: 2025-01-04 00:00:00 +09:00
categories: [experiments]
math: true
---

## 1. 개요

> - 본 프로젝트는 물류센터의 **입하 최대용량(CAPA) 제약** 상황에서, 자동발주 시스템이 일부 발주를 취소해야 하는 경우 **자동발주취소 우선순위(rank)** 를 결정하는 ML 모델을 개발한 사례입니다.
> - 모델은 **Non-negative Linear Regression(NNLS)** 기반으로 설계되어, 각 피처가 **매출에 긍정적으로 기여하는 정도(weight)** 를 해석 가능한 형태로 제공합니다.
> - 사용된 모델에 대한 포스팅은 다음을 참조 : [Non-negative Linear Regression의 개념 및 사용](https://data-bility.github.io/posts/Non-negative-Linear-Regression%EC%9D%98-%EA%B0%9C%EB%85%90-%EB%B0%8F-%EC%82%AC%EC%9A%A9/)

---

## 2. 문제 정의 및 배경

- 입하 최대용량(이하 CAPA)를 초과할 때, 자동발주 시스템은 일부 SKU의 발주를 취소해야 합니다.
- 그러나 위탁배송 형태의 신규 센터에서는 아직 자동화 로직이 완전히 적용되지 않아, CAPA 초과 시 관리자가 직접 발주 취소 여부를 판단해야 하는 상황이 발생했습니다.

이로 인해 다음과 같은 문제가 발생했습니다.

- **마진이 높은 SKU**가 단순히 CAPA 한계로 인해 취소되는 경우
- **행사/할인 상품** 등 수요 민감도가 높은 상품을 사람이 일일이 검토해야 하는 비효율
- CAPA 초과량은 줄이지만, **무엇을 남기고 무엇을 취소할지에 대한 기준이 불명확**

이러한 한계를 해결하기 위해, **SKU별 매출 기여도와 중요도를 정량화하여, CAPA 초과 시 자동발주 취소 우선순위를 산정하는 모델**의 개발이 필요했습니다.

---

## 3. 모델 설계 및 수학적 정의

상품 단위로 **입하예정일(`exp_in_stock_date`)** 기준의 로그화 매출(`log_sum_sales`)를 목표 변수로 설정하고, 판매가/마진/품절시간/할인율 등의 주요 지표를 입력 피처로 사용했습니다.

$$
\min_{\beta \ge 0} ||y - X\beta||_2^2
$$

- 각 피처의 회귀계수 $ \beta_i $는 “해당 변수가 매출에 미치는 양(+)의 기여도”를 의미합니다.
- **비음수 제약($ \beta \ge 0 $)** 으로 인해 해석 가능한 가중치 구조를 얻을 수 있습니다.

| Feature | 설명 | 기대 부호 |
|----------|------|-------|
| `log_tot_sell_prc` | 총 판매가(log) | (+)   |
| `log_tot_mrgprc` | 총 마진(log) | (+)   |
| `oos_time` | 운영 시간 내 품절 시간 | (+)   |
| `dscnt_rat` | 할인율 | (+)   |


---

## 4. 학습, 적용 운영 방식 (스케줄 중심)

본 모델은 **"주간 학습(월요일) -> 일일 적용(화~월)"** 의 고정 Weight 운영 전략을 채택했습니다.

### 4.1 주간 학습 (매주 월요일)

- **학습 윈도우**: `save_dt`(월요일) 기준 **[-35일, -7일)** 데이터
- **타깃**: `log_sum_sales` (입하예정일 기준 로그화 된 총 매출)
- **설명변수**: `log_tot_sell_prc`, `log_tot_mrgprc`, `oos_time`, `dscnt_rat`
- **모델**: `sklearn.LinearRegression(positive=True)`
- **산출물**: 컬럼별 가중치(`col_nm`, `weight`) **Parquet 저장**
  - 구성:
    - (A) **핸드크래프트 가중치**: `sqrt_scls_item_cnt`, `pord_cncl_cnt_28d`, `ld_pord_cncl_val`, `inv_dcnt`
    - (B) **NNLS 학습 가중치**: `log_tot_sell_prc`, `log_tot_mrgprc`, `oos_time`, `dscnt_rat`

이렇게 학습된 Weight 스냅샷은 그 주간(화~월) 동안 고정적으로 사용됩니다.

### 4.2 일일 적용 (매일 새벽)
- 실행 순서 : 주간 학습 배치 -> 매일 일일 적용 배치 
- 입력 Weight를 넣어줌.
- 일일 산출: 해당일(D), 익일(D+1) 취소 우선순위 랭킹 및 부분취소 수량 산출
- 코어 로직
  1. Min-Max Scaling: 학습 시 사용한 수치 피처를 동일 스케일로 변환
  2. 가중치 적용: 컬럼별 스코어(col * weight) 합산 -> capa_cncl_scr 계산 
  3. 순위 : capa_cncl_scr 오름차순, 동점 시 재고 많은 상품 우선 
  4. 부분취소: 운영지표, 재고/마진/구색/할인 점수로 cncl_rt, cncl_qty 계산 후 if

---

## 5. 모델 결과 해석 / 효과

> - 본 모델의 가장 큰 장점은 '해석 가능성(interpretability)' 입니다. 
> - 비음수 회귀(Non-negative Linear Regression)는 각 피처의 회귀계수가 항상 양(+) 방향만을 가지므로, "어떤 요인이 발주 유지(또는 취소 방지)에 얼마나 기여하는지"를 직관적으로 해석할 수 있습니다.

### 모델 결과 해석

주간 학습에서 도출된 NNLS 계수가 아래 예시와 같은 경우라면 다음과 같이 해석할 수 있습니다. :

| Feature            | Weight | Interpretation                 |
| ------------------ | ------ |--------------------------------|
| `log_tot_sell_prc` | 0.42   | 고가 상품일수록 유지 우선                 |
| `log_tot_mrgprc`   | 0.37   | 마진 높은 상품 유지 우선                 |
| `oos_time`         | 0.09   | 품절시간 길수록 유지 우선 (취소 지양) |
| `dscnt_rat`        | 0.12   | 할인율 높은 상품 유지 우선                |


이처럼 NNLS 모델은 **방향성이 양(+)으로 보장된 가중치 구조** 덕분에, 기존의 일반 회귀모델(OLS)처럼 부호가 뒤집혀 해석이 어려운 문제가 없습니다.

- 예를 들어, 다중공선성(collinearity)이나 내생성(endogeneity)으로 인해 할인율이 높을수록 취소 우선순위가 낮아진다는 식의 비논리적 부호 반전이 발생하지 않습니다.
- NNLS는 이러한 부호 불안정성을 구조적으로 차단함으로써, 실무자가 결과를 해석하고 의사결정 규칙으로 바로 전환하기 용이한 모델이라는 점에서 큰 장점이 있습니다.

### 도입 효과


| 구분         | 기존(신규 위탁배송 센터, 수동 판단) | 모델 도입 후(주간 고정 Weight) |
| ---------- | --------------------- |-----------------------|
| CAPA 초과 대응 | 운영자 수작업 판단            | **자동 산정** (랭킹+부분취소)   |
| 일관성/해석성    | 개인 경험 의존              | **가중치 근거 기반** 설명 가능   |
| 의사결정 속도    | 느림                    | **자동**                |



- "월요일에 학습된 고정 Weight"로 일주일간 일관된 취소 우선순위를 제공하여, 신규 위탁배송 센터의 수동 판단 의존도를 대폭 축소했습니다.
- NNLS 기반 설계로 부호 일관성(해석력) 을 확보했고, 핸드크래프트 가중치와 하이브리드하여 도메인 룰을 동시에 반영했습니다.


---


## 6. 회고 및 한계
- 비음수 회귀(Non-negative Linear Regression) 이 해석 가능한 가중치 구조를 제공하며 취소 우선순위 결정 로직을 안정적으로 만드는 데 도움을 준다는 점을 확인했습니다.

다만, 다음과 같은 한계점도 명확히 존재했습니다.

### 6.1 정적(Static) 가중치 구조의 한계
- 매주 월요일 한 번 학습한 가중치를 일주일간 고정하여 사용하는 구조는 데이터 분포가 빠르게 변하는 시기에 즉각적인 반응이 어렵습니다. 
- 예를 들어, 특정 요일의 프로모션 효과나 급격한 물류 이슈는 반영되지 않을 수 있습니다. Rolling Window 방식으로라도 업데이트 하는 것이 어떨까 하는 생각이 있습니다.

### 6.2 상호작용(Interaction) 효과의 미반영
- NNLS는 단순 선형 모델이기 때문에, 피처 간 상호작용(예: 할인율 * 품절시간)을 반영하지 못합니다.
- 결과적으로, 일부 상황에서는 "할인율은 높지만 이미 품절 중인 상품" 처럼 서로 충돌하는 신호를 단순 합산 점수로 처리하게 되어 순위 왜곡이 발생할 수 있습니다.

### 6.3 제약 조건이 예측력(Accuracy)에 미치는 영향
- 부호 제약($ \beta >= 0 $)은 해석에는 유리하지만, 자유도가 줄어들어 약간의 성능 저하를 유발할 수 있습니다.
