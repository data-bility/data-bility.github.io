---
title: 주간 워크 포워드 최적화 기반 파라미터 동적 재보정
date: 2024-12-30 00:00:00 +09:00
categories: [experiments]
math: true
---
> - 본 글은 신규 센터(NE.O.004) 오픈 초기의 **데이터 부족 상황**에서, Croston method의 지수평활계수 $ \alpha $를 **주간 단위 워크 포워드 평가를 통해 동적으로 재보정**하여, 데이터 부족 환경에서도 안정적인 기초 수요예측을 달성한 사례를 정리합니다.  
> - Croston 기법 자체에 대한 수식 및 배경은 이전 글을 참고하세요: [Croston method: 간헐적 수요 예측을 위한 고전적 접근방법](https://data-bility.github.io/posts/Croston-method-%EA%B0%84%ED%97%90%EC%A0%81-%EC%88%98%EC%9A%94-%EC%98%88%EC%B8%A1%EC%9D%84-%EC%9C%84%ED%95%9C-%EA%B3%A0%EC%A0%84%EC%A0%81-%EC%A0%91%EA%B7%BC%EB%B0%A9%EB%B2%95/)

---
## 1. 프로젝트 배경

- **기간**: 2024.12
- **대상**: SSG NE.O.004 자동화물류센터(신규)
- **문제**: 학습 가능한 과거 데이터가 부족 -> ML 모델 도입 전, **통계 기반 기초예측** 필요
- **기초예측 후보**:
  - 28일 이동평균(MA28)
  - 49일 요일평균(DOW49)
  - **Croston method ($ \alpha \in \{0.1, 0.2, 0.3\} $)**
- **핵심**: Croston method의 alpha를 고정하지 않고, **매주 월요일** 배치에서 **사후 평가**로 SKU별 최적 smoothing parameter alpha를 선택

---

## 2. 배치 설계 개요 (월요일 주간)

- 스케줄: *월요일 주배치*
- 실행 순서: **`기초모형 주간 사후 평가` -> `최종 모델 선택(Bayesian Optimizer 기반 모델 선택 로직 통합 가능)`**
- 평가 기간: 최근 **365일** (센터 특성 및 가용 데이터에 따라 조정 가능)
- 평가 제외: **명절/특수휴일 제외**, **점포 휴무 제외**, **oper_cnt > 0 (정상 운영일)**

---

## 3. Croston alpha 동적선택 — 주간 사후 평가 로직

### 3.1 평가 지표와 선택 규칙

- 기본 지표: **sMAPE**, **MAE**, **정규화 MAE (nMAE = MAE / 평균실적)**
- 선택 규칙(요지):
  1) sMAPE가 정상적으로 계산되는 SKU에 대해서는 **sMAPE 최소** alpha 선택
  2) sMAPE가 비정상(예: 극단치로 200 상한 처리) 또는 결측이면 **nMAE 최소** alpha 선택
  3) nMAE 비교가 곤란하면 **MAE 최소**로 fallback 처리

> 이 규칙은 **월요일 = 생성 기준일**을 기준으로 삼아, **지난 주(또는 정의한 고정 리드타임 오프셋)** 의 예측값과 실제를 맞춰 보는 순수 **사후 평가** 방식입니다.

### 3.2 `기초모형 주간 사후 평가` 의사코드 (지표 산출 + alpha 선택)

```text
# INPUT
- 판매실적 from feature store
- 예측결과:
  - weeklyma(MA of weekday)
  - moveavg30(MA30)
  - croston_method(alpha=0.1, 0.2, 0.3 각각 산출되어 있다고 가정)
- 휴일/명절 테이블 (평가 제외용)
- critn_dt := 월요일(기준일)

# PREP
- 평가대상일: [critn_dt - 365, critn_dt - 1]  ∩ (명절 X, 점포휴무 X, oper_cnt > 0)
- join(실적 y, 각 기초예측 predt) on (salestr_no, bizcnd_cd, offline_item_id, predt_dt)

# METRIC
- sMAPE := mean(  |y - predt| / ((|y| + |predt|)/2) * 100  )
- MAE   := mean(  |y - predt|  )
- y_avg := mean( y )
- nMAE  := MAE / y_avg

# α SELECTION (Croston only)
for each (salestr_no, bizcnd_cd, offline_item_id) as id:
  for alpha in {0.1, 0.2, 0.3}:
    compute sMAPE, MAE, nMAE on evaluation window
  if valid(sMAPE):
    pick alpha with min sMAPE
  else if valid(nMAE):
    pick alpha with min nMAE
  else:
    pick alpha with min MAE
  persist metrics (by id, α, critn_dt) -> base_mdl_metric/mdl=croston_method/critn_dt=each monday

# OTHER BASELINES
- 동일 윈도우/필터로 weeklyma, moveavg30 지표도 함께 산출, 저장
```

- 산출물은 base_mdl_metric 영역에 모델별(weeklyma / moveavg30 / croston_method), 기준일별로 저장됩니다. 
- croston_method의 경우에는 이때 '선택된 alpha'에 해당하는 성능 지표가 기록됩니다.

---

## 4. 기초예측 모델 선택 및 자동발주 연계

다음 단계 `최종 모델 선택`에서는 3.에서 저장한 성능 지표들을 불러와, 기초예측 모델( MA28 / DOW49 / croston_method) 중 SKU별로 가장 우수한 후보를 선택합니다.

### `최종 모델 선택` 의사코드
```text
# INPUT
- base_mdl_metric (from base_mdl_eval output):
  id, mdl in {weeklyma, moveavg30, croston_method}, sMAPE, nMAE, MAE, critn_dt
- 기준일 critn_dt := 월요일

# PICK BEST BASELINE PER SKU
for each id:
  # 지표 사용 우선순위: sMAPE 정상 < nMAE < MAE
  candidate := argmin_by_priority(id, mdl, sMAPE, nMAE, MAE)
  mark candidate.mdl as best_baseline

# OUTPUT
- 영업점/SKU 별 최종 선택 모델
```

두 과정을 요약하면 : 
1) 월요일마다 “지난 1년 평가 결과”를 최신화
2) alpha 선정
3) 3개 기초모형 간 베스트 선택
4) 자동발주 가능 여부 산출의 순환을 자동화

## 5. 왜 워크 포워드 최적화 기반으로 alpha를 동적 선택하게 설계 했는가? 

- 데이터 부족 기간의 현실적 제약: 사전 튜닝용 홀드아웃 구성도 어려운 SKU가 많음 
- 안정성: 지난 1년의 운영일 기준 결과를 주기적으로 재평가하면, 과대적합 위험을 줄이면서도 alpha를 환경 변화에 맞춰 서서히 업데이트 가능
- 운영 단순성: alpha 후보를 작게(0.1/0.2/0.3) 두면 계산비용, 운영복잡도를 관리하면서도 반응성(최근성) <-> 안정성(평활)의 트레이드오프를 SKU별로 자동 보정
  - 한편, 문헌 상으로도 croston method의 alpha 값은 최대 0.3 정도로 사용하는 것이 일반적이었음.

## 6. 성과

- 신규 오픈 센터 자동발주 수요예측 서비스 오픈(2024.12)
- ML 학습 파이프라인 도입 전까지 안정적 기초예측 제공
- Croston alpha의 주간 재선정으로 운영 SKU별 예측 민감도 자동 보정
- 기존 Bayesian Optimizer 로직의 확장성을 고려하여 설계했으므로, 이후 ML(예: XGBoost/Ridge/ElasticNet) 기반 최적화 파이프라인으로 무리 없이 전환 가능

## 7. 회고 및 한계
### 7.1 한계
- alpha 후보가 {0.1, 0.2, 0.3}로 제한됨 -> 연속값 최적화에 비해 정밀도는 낮을 것임.
- sMAPE 특성상 0 근처에서 불안정 -> 보정(상한 처리 등)과 nMAE 폴백 규칙이 필수적이었음.
- 수요 급변 시점에는 주간 단위 갱신만으로는 반응이 늦을 수 있음.

### 7.2 개선 아이디어
- SKU별 변동성 레짐 탐지 후 일시적으로 alpha 상향 (예: 이벤트/프로모션 구간)
- 가중 sMAPE / 비용가중 MAE(under/over 비용 차등)로 선택 규칙 고도화
- 일정 데이터 축적 뒤, 베이지안 최적화+크로스밸리데이션으로 ML 전환 및 혼합(blending)
