---
title: 자동화물류센터 수요예측 고도화 - Poisson XGB, TFT 모델 
date: 2025-04-20 00:00:00 +09:00
categories: [experiments]
math: true
---

> - 본 글은 **SSG.COM의 NE.O.004 자동화물류센터** 오픈 초기의 데이터 부족 환경에서, 수요예측 체계를 통계적 접근에서 머신러닝 기반으로 전환한 사례를 다룹니다.
>   - [Croston method - 주간 워크 포워드 최적화 기반 파라미터 동적 재보정](https://data-bility.github.io/posts/Croston-method-%EC%A3%BC%EA%B0%84-%EC%9B%8C%ED%81%AC-%ED%8F%AC%EC%9B%8C%EB%93%9C-%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B8%B0%EB%B0%98-%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0-%EB%8F%99%EC%A0%81-%EC%9E%AC%EB%B3%B4%EC%A0%95/) 프로젝트 이후 ML 모델 도입 과정에 대한 내용입니다.
> - 특히 **XGBoost_count:Poisson** 과 **TFT(Temporal Fusion Transformer)** 를 새롭게 도입하였습니다.
> - 각 모델에 대한 설명은 아래 포스트를 참조 :
>   - [포아송 회귀를 위한 XGBoost](https://data-bility.github.io/posts/%ED%8F%AC%EC%95%84%EC%86%A1-%ED%9A%8C%EA%B7%80%EB%A5%BC-%EC%9C%84%ED%95%9C-XGBoost/)
>   - [Temporal Fusion Transformer (TFT) 모델 개요](https://data-bility.github.io/posts/Temporal-Fusion-Transformer-(TFT)-%EB%AA%A8%EB%8D%B8-%EA%B0%9C%EC%9A%94/)

---

## 1. 배경

- NE.O.004 센터는 오픈 초기 데이터가 제한적이었으며, 수요 패턴은 간헐적(intermittent)이고 0-inflated 형태를 띠었습니다.  
- 기존의 `Croston method` 및 `30일 이동평균` 기반 예측은 안정적 baseline이었으나, **이벤트, 프로모션, 요일 효과 등 비선형적 요인**을 반영하기에는 한계가 있었습니다.

이에 따라, 
- Poisson 목적함수를 활용한 **XGBoost_count:Poisson** 모델로 과소예측 문제를 완화하고
- **Temporal Fusion Transformer(TFT)** 를 추가하여 시계열의 장, 단기 패턴을 통합적으로 학습하는 구조로 확장하게 되었습니다.


---

## 2. XGBoost_count:Poisson 도입 배경

[포아송 회귀를 위한 XGBoost](https://data-bility.github.io/posts/%ED%8F%AC%EC%95%84%EC%86%A1-%ED%9A%8C%EA%B7%80%EB%A5%BC-%EC%9C%84%ED%95%9C-XGBoost/)에서도 다룬 내용이지만 :

- `count:poisson` 목적함수는 수요가 음이 아닌 정수로 표현되는 환경에 적합합니다.  
- 특히 **과소예측(underprediction)** 시 강한 상향 보정 압력을 갖는 **비대칭적 손실 구조** 덕분에, 품절 리스크가 큰 e-commerce 환경에 효과적으로 대응할 수 있으리라 기대했습니다.

### 손실함수 및 미분 구조

$$
\mathcal{L} = -\sum_i \left( y_i \log(\lambda_i) - \lambda_i - \log(y_i!) \right)
$$

$$
g_i = \exp(\hat{y}_i) - y_i, \quad h_i = \exp(\hat{y}_i)
$$

- **예측이 낮을 때 (과소예측)** -> $g_i$는 큰 음수 -> 모델이 강하게 **상향 보정**
- **예측이 높을 때 (과대예측)** -> $h_i$가 커져 gradient 효과 완화 -> **완만한 수정**

즉, 손실함수 자체가
> “과소예측에는 민감하고, 과대예측에는 완만한” 형태의 **비대칭 경사 압력(asymmetric gradient pressure)** 을 내포합니다.

이로 인해 `count:poisson` 사용을 통해, 기존 XGBoost 대비 다음 효과를 기대하였습니다 :
- 과소예측 리스크 감소
- 0 값 근처 예측의 안정성 확보  
- 이벤트 발생 시 수요 증가 반영 속도 향상


--- 

## 3. TFT (Temporal Fusion Transformer) 도입 배경

기존 ML 모델(XGBoost, LightGBM 등)은 타 센터 수요예측에 대해서 **정적인 피처 기반 예측**에는 강한 모습을 보여왔지만, 시간에 따라 달라지는 패턴(요일, 프로모션, 리드타임 효과 등)을 **연속적으로 학습하는 것이 맞는지에 대한 의문**이 있었습니다.

특히 NE.O.004 환경처럼 :
- 판매 이력은 짧고
- 이벤트 효과는 비선형적이며
- 일부 미래 피처(예: 할인, 캠페인)가 확정되지 않은 상황  

단순 회귀 모델로는 충분한 시계열 표현력을 확보하기 어려웠습니다.

그러한 이유로 Google Research의 **Temporal Fusion Transformer (TFT)** 모델을 수요예측 파이프라인에 신규로 도입했습니다.  

TFT는 LSTM 기반의 인코더/디코더와 Transformer의 Attention 구조를 결합한 모델로, 시계열 내 **단기적 변동성과 장기적 추세를 동시에 반영**할 수 있음을 문헌 연구 과정에서 확인했기 때문입니다. <br>


| 목적 | 기대 효과                                             |
|------|---------------------------------------------------|
| 시간 종속성 강화 | 요일, 프로모션 등 시계열적 변동 패턴 학습                          |
| 미래 피처 결측 대응 | 일부 미래 피처가 미정이어도 안정적 예측 가능                         |
| 해석 가능성 확보 | Attention + VSN을 통한 시점별 영향력 시각화                   |
| 모델 확장성 확보 | PyTorch Forecasting 기반으로 Airflow, Ray 환경 통합 운영 가능 |

> (참고) 모델의 구조적 특징에 대해서는 이전 게시글 [Temporal Fusion Transformer (TFT) 모델 개요](https://data-bility.github.io/posts/Temporal-Fusion-Transformer-(TFT)-%EB%AA%A8%EB%8D%B8-%EA%B0%9C%EC%9A%94/)에서 다뤘습니다.

---

## 4. 파이프라인 구조

NE.O.004 자동화물류센터의 수요예측 파이프라인은 [SSG 1DAY 배송 - 자동발주예측 ML모델 고도화](https://data-bility.github.io/posts/SSG-1DAY-%EB%B0%B0%EC%86%A1-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%9E%90%EB%8F%99%EB%B0%9C%EC%A3%BC%EC%98%88%EC%B8%A1-ML%EB%AA%A8%EB%8D%B8-%EA%B3%A0%EB%8F%84%ED%99%94/) 프로젝트에서 개발된 **Bayesian Optimization 기반 모델 선택 구조**를 그대로 사용했습니다.

### 4.1 모델 선택 구조

| 단계            | 설명                                                                              |
|---------------|---------------------------------------------------------------------------------|
| 1. 모델 후보군 정의  | Ridge, Lasso, ElasticNet, XGBoost, LightGBM, RandomForest, Poisson XGBoost, TFT |
| 2. 하이퍼파라미터 탐색 | Bayesian Optimization 기반 Gaussian Process 탐색                                    |
| 3. 검증 지표      | Validation 구간의 MAE, SMAPE, nRMSE                                                |
| 4. 모델 선택      | SKU 단위로 최저 Validation MAE 모델 선택 및 저장                                            |
| 5. 주간 재보정     | Airflow 주간 배치로 재학습 및 최적 모델 업데이트                                                 |

SKU별로 Validation 성능이 가장 좋은 모델을 자동 선택하며, 시뮬레이션 결과, **Poisson XGBoost는 간헐 SKU**, **TFT는 트렌드 SKU** 에 주로 선택되는 경향을 보였습니다.

다만 TFT는 이벤트 발생 시 **과대예측 경향**이 관찰되어, 최종적으로는 **TFT와 “최종 선택된 비-TFT 모델”의 단순 가중평균(0.5 : 0.5)** 으로 예측값을 결합하는 구조를 채택했습니다. 이는 이론적 접근이라기보다 **실증적으로 예측 오차가 가장 낮게 관찰된 조합**이었기 때문입니다.

결과적으로,
- TFT는 **간헐 SKU에 강점을 가진 Poisson 모델군**을 보완하는 **트렌드 SKU 대응형 보조 모델**로 기능해졌으며
- 두 예측을 단순 가중평균(blending)함으로써, **예측 안정성과 추세 민감성**을 모두 확보했습니다.

---

### 4.2 구성 요약

프로젝트의 전체 구성을 요약하면 아래와 같습니다. 

| 항목 | 기술 구성 |
|------|------------|
| 언어/환경 | Scala, Python, PySpark |
| 분산 학습 | Ray 기반 Parallel Bayesian Optimization |
| 스케줄링 | Apache Airflow (주간 학습, 일간 예측) |
| 모델 | XGBoost(count:poisson), TFT, Ridge, Lasso, ElasticNet, LightGBM |
| 저장/연동 | GCS 기반 모델 관리 및 협업 DB 연계 |


---

## 5. 성과 및 회고

### 5.1 정량적 성과

| 지표 | 개선율(%) | 비고 |
|------|-----------|------|
| **RMSE** | 평균 12.8% 감소 | 기존 이동평균 대비 |
| **MAPE** | 평균 9.4% 감소 | 간헐 SKU 중심 |
| **SMAPE** | 평균 11.7% 감소 | 전체 SKU 평균 |

- **Poisson XGBoost** 도입으로 **과소예측(Under-forecasting)** SKU 비율이 유의미하게 감소했습니다.
- **TFT 모델** 추가로 이벤트, 프로모션 등 **트렌드 SKU의 변동성 예측 성능**이 향상되었습니다.

---

### 5.2 정성적 개선 및 통합 효과

| 구분 | 주요 개선 내용 |
|------|----------------|
| **예측 안정성** | 간헐 SKU에는 Poisson XGB, 트렌드 SKU에는 TFT가 보완적으로 작동하는 구조 확립 |
| **운영 효율** | Ray 기반 분산 학습 + Airflow 자동 스케줄링으로 주간 재학습 자동화 |
| **모델 해석력** | TFT의 Attention 및 VSN으로 피처 영향도 시각화, 예측 과정 해석 가능 |
| **일관된 관리체계** | Bayesian Optimization 기반 모델 선택 로직을 1DAY 파이프라인과 통합, 관리 일원화 |

- 다만, 모델 해석력과 drift 모니터링 측면에서는 개선 여지가 있습니다. 
- 현재는 모델러가 직접 데이터를 조회해야만 성능 저하나 데이터 분포 변화를 확인할 수 있으므로, **시각화 기반 모니터링 프레임워크 도입**이 필요하다고 판단했습니다.

---

### 5.3 향후 계획

본 프로젝트를 통해 **간헐 SKU 예측 안정성(포아송 회귀)** 과 **트렌드 SKU 감도 확보(TFT)** 의 두 축을 확보했지만, 운영 단계에서 다음 세 가지 개선 방향이 도출되었습니다.

- **블렌딩 로직 고도화**  
  - 현재는 **TFT와 최종 선택된 비-TFT 모델의 단순 가중평균(0.5 : 0.5)** 구조로 결합하고 있습니다.  
  - 향후에는 SKU 특성(판매 빈도, 변동성)에 따라 가중치를 자동 조정하는 **adaptive blending** 방식을 검토할 예정입니다.  
  - 예를 들어, `w_tft = f(trend_score)`, `w_selected = f(intermittency)` 형태의 **동적 가중 함수**를 설계하여 SKU별 예측 특성에 따라 자동으로 가중치를 조정하는 방향입니다.

- **해석 및 모니터링 자동화**  
  - TFT의 Attention 가중치와 다른 모델의 Feature Importance를 통합 시각화하여, SKU별 예측 영향도를 정기적으로 추적할 수 있는 **모델 해석 대시보드**에 대한 필요성을 확인했습니다.  
  - 이를 통해 **예측 drift**, **feature shift** 등을 주간 단위로 감지하고, 모델의 상태를 실시간 모니터링할 수 있는 ML 운영 체계로 확장할 수 있을 것입니다.

- **모델 선택 구조 개선**  
  - Validation 기반 단일 선택 구조에서 벗어나, 모델 간 **불확실성(Uncertainty)** 과 **일관성(Consistency)** 을 함께 고려한 **확률적 모델 선택(probabilistic selection)** 방식을 검토하고 있습니다.  
  - 예측 분포의 신뢰구간(quantile)을 활용하여 모델 간 **confidence-weighted 선택 구조**를 구현하는 방향이 어떨까 싶습니다.
