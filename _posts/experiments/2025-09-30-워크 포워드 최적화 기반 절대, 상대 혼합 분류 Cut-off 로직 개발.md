---
title: 워크 포워드 최적화 기반 절대/상대 혼합 분류 Cut-off 로직 개발
date: 2025-09-15 00:00:00 +09:00
categories: [experiments]
math: true
---

> - 본 내용은 **NE.O 자동화물류센터 주간 품절상품 분류모델** 운영 중, 기존의 **고정 Cut-off (0.7)** 설정이 데이터 드리프트에 의해 불안정해진 이후, 이를 개선하기 위해 설계된 **절대적/상대적 혼합 Cut-off 로직**의 개발 과정을 다룹니다.  
> - 이전 단계의 모델 개발 내용은 [주간 품절상품 분류 모델 개발기](https://data-bility.github.io/posts/%EC%A3%BC%EA%B0%84-%ED%92%88%EC%A0%88%EC%83%81%ED%92%88-%EB%B6%84%EB%A5%98-%EB%AA%A8%EB%8D%B8-%EA%B0%9C%EB%B0%9C%EA%B8%B0/)를 참고해주시길 바랍니다.

---
## 1. 배경과 문제 인식

### 1.1 문제 인식 
분류 모델 개발 초기 프로젝트에서는 모든 주차에 대해 동일한 절대 Cut-off(0.7)를 적용했습니다. 

하지만 시간이 지나며 분류모델에서 산출되는 예측 확률값이 전반적으로 **상승(drift)** 하는 현상이 관찰되었습니다. :

- 일부 주차에서 품절 SKU가 늘어나거나, 모델 업데이트 후 전체 확률 분포가 우측으로 이동
- 이에 따라 동일한 Cut-off(0.7)를 적용하면 **Positive SKU 수의 급감 또는 급증**이 발생
- Precision/Recall의 변동성이 커지며, 운영 측면에서도 **개입 SKU 수의 일관성**이 유지되지 않음

이를 해결하기 위해, 학습 기준일자 기준으로 지난 주(week-1) 데이터를 활용하여 **동적으로 Cut-off를 재산출**하는 방식을 도입했습니다.

### 1.2 성과 요약 (2025.07–2025.09 기간 시뮬레이션)

| 센터       | 평균 Precision | 평균 Recall | 평균 F1 | Cut-off 방식 | 특징                                 |
|----------|----------------|-------------|----------|---------------|------------------------------------|
| **센터 1** | 0.55 | 0.38 | 0.44 | **혼합 Cut-off (본 로직)** | Precision, F1 정책 목표 내 안정화          |
| **센터 2** | 0.55 | 0.42 | 0.45 | **혼합 Cut-off (본 로직)** | 불균형 완화, 고정 Cut-off 대비 F1 +0.05p 개선 |

- 고정 Cut-off(0.7)를 사용하던 시점 대비, **Precision의 변동 폭은 절반으로 줄고(F1 평균 +0.05p)**, Positive SKU 수의 변동 폭은 $ \pm $8% 이내로 안정화되었습니다.
- 결과적으로 대행사 기간(시뮬레이션 기간) 내 주차별 예측값의 **확률 분포 이동(Drift)** 에 대해서도 Precision 성능 저하 없이 유연하게 대응할 수 있었습니다.

---

## 2. 설계 개념

Cut-off는 다음 두 기준을 동시에 고려합니다.

1. **절대적 기준 (Absolute Cut-off)**
  - 전주 데이터의 PR 곡선을 기반으로 **F1-score가 최대**이면서 **Precision ≥ 0.5** 를 만족하는 확률값을 선택합니다.
  - 단, Youden’s J (TPR + TNR - 1) 기준도 병행 계산하여 비교함.

2. **상대적 기준 (Relative Cut-off)**
  - 확률값 분포의 상위 분위수(q%)를 기준으로 결정합니다.
  - q는 {5, 10, 15, 20, 25} 중 최적값을 선택 (전주 평가 기반)

최종 Cut-off는 다음과 같이 결정됩니다. :

$$
\text{Final Cutoff} = \max(\text{Absolute}, \text{Relative}), \quad \text{단 } < 0.5 \text{ 인 경우 } 0.5 \text{ 로 보정}
$$

---

## 3. 구현 흐름

| 단계 | 역할 요약                                         |
|----|-----------------------------------------------|
| 1  | 전주 예측결과와 실제 라벨 비교 -> Precision, Recall, F1 계산 |
| 2  | 전주 기준 PR 곡선 및 분위수 기반 Cut-off 산출               |
| 3  | 금주 예측결과에 새로운 Cut-off 적용                       |

---

## 4. 절대 Cut-off 산출 로직 (의사코드)

```python
def find_absolute_cutoff(y_true, y_prob):
    precision, recall, thresholds = precision_recall_curve(y_true, y_prob)
    f1 = 2 * precision * recall / (precision + recall + 1e-9)
    mask = (precision >= 0.5)
    f1_filtered = np.where(mask, f1, -np.inf)

    abs_cutoff_f1 = thresholds[np.nanargmax(f1_filtered)]
    youdens_j = recall + (1 - (fp / (fp + tn))) - 1
    abs_cutoff_j = thresholds[np.nanargmax(youdens_j)]
    return max(abs_cutoff_f1, abs_cutoff_j)
```

> 핵심 아이디어
> - Precision >= 0.5를 만족하는 구간에서 F1이 최대가 되는 지점을 선택하여, "과잉 탐지(False Positive)" SKU 수를 제한하면서도 Recall 손실을 최소화합니다.

---

## 5. 상대 Cut-off 산출 로직 (의사코드)

```python
def find_relative_cutoff(y_prob, q_candidates=[5,10,15,20,25]):
    cutoffs = []
    for q in q_candidates:
        rel_cutoff = np.percentile(y_prob, 100 - q)
        cutoffs.append((q, rel_cutoff))
    return cutoffs
```

> 상대적 기준은 "확률 상위 q%"를 Positive로 취급하는 방식으로, 분포가 이동하더라도 일정 비율의 상위 SKU를 확보할 수 있습니다.

---

## 6. 최종 로직 (의사코드)

```python
def final_cutoff(abs_cutoff, rel_cutoff):
    cutoff = max(abs_cutoff, rel_cutoff)
    return max(cutoff, 0.5)  # 최소 보정
```

> 이 과정을 매주 월요일 `사후 평가` task 에서 실행하여, 다음 주(week+1) 예측에 적용합니다.


---

## 7. 실험 결과 
- 기간 : 2025.07 ~ 2025.09 대규모 행사 존재하는 기간 내 시뮬레이션 진행
- 결과 요약
  
  | 센터       | 평균 Precision | 평균 Recall | 평균 F1 | Cut-off 방식 | 특징                                 |
  |----------|----------------|-------------|----------|---------------|------------------------------------|
  | **센터 1** | 0.55 | 0.38 | 0.44 | **혼합 Cut-off (본 로직)** | Precision, F1 정책 목표 내 안정화          |
  | **센터 2** | 0.55 | 0.42 | 0.45 | **혼합 Cut-off (본 로직)** | 불균형 완화, 고정 Cut-off 대비 F1 +0.05p 개선 |

  - 전반적 성능 안정화 : F1 평균이 약 0.44 ~ 0.45로 수렴하며, Cut-off 보정 이후에도 성능 유지.
  - Precision 안정성 향상 : 주차별 변동 폭이 $ \pm $ 0.08 -> $ \pm $ 0.04 수준으로 감소.
  - Positive SKU 확보 안정성 : 전주 대비 확보 SKU 수 변동률 $ \pm $ 8% 이내.
  - Best Case : PR 최적점 기반 보정으로 Precision 0.73, F1 0.51을 기록하며 최적 균형 달성.


- 주차 별 Precision
  
  <img src="/assets/img/precision_over_time.png" width="500px" height="220px" alt="precision 실험 결과">

- 주차 별 F1

  <img src="/assets/img/f1_over_time.png" width="500px" height="220px" alt="f1 실험 결과">

---

## 8. 회고 및 향후 계획

- **효과**
  - Cut-off를 주차별로 자동 보정하여 Positive SKU 수의 변동성을 완화함.
  - Precision/Recall 균형이 유지되며, 정책적으로 목표한 수준의 예측 안정성을 달성함.


- **관찰된 특징**
  - **센터 1**은 확률 분포의 Drift 폭이 커, Cut-off 보정 효과가 특히 뚜렷하게 나타남.
  - **센터 2**는 분포 자체는 상대적으로 안정적이지만, 이벤트 기간(예: 대형 행사)에 따른 영향이 크게 나타남.
  - 두 센터 모두 9월 이후에는 F1-score가 회복세를 보이며, **Cut-off 동적 보정의 실효성**이 검증됨.


- **한계**
  - Youden’s J 기준은 클래스 불균형이 심한 시점에서 threshold 변동성이 높음.
  - PR 곡선이 불연속(discrete)하거나 샘플 수가 적은 주차에서는 F1 최대점 탐색이 불안정할 수 있음.
  - 일부 구간에서는 Cut-off 보정이 Recall 향상보다 Precision 유지에 더 치중되는 경향이 있음.
