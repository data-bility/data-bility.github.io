---
title: SSG 1DAY 배송 - 자동발주예측 ML모델 고도화
date: 2024-02-29 00:00:00 +09:00
categories: [experiments]
math: true
---
이 글은 [experiments 카테고리의 **“SSG 1DAY 배송 - 신규 센터 수요예측 파이프라인 구축기”**](https://data-bility.github.io/posts/SSG-1DAY-%EB%B0%B0%EC%86%A1-%EC%8B%A0%EA%B7%9C-%EC%84%BC%ED%84%B0-%EC%88%98%EC%9A%94%EC%98%88%EC%B8%A1-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%B6%95%EA%B8%B0/) 작업의 고도화 프로젝트를 다룬 내용입니다.

> **요약**  
> - 기존 이동평균 기반의 단순 예측 방식을 벗어나, **영업점 × SKU 단위 ML 수요예측 모델**을 구축  
> - **베이지안 최적화 기반 모델 선택** 및 **Airflow 자동 스케줄링 파이프라인**을 도입함

---
## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| 기간 | 2024.01 ~ 2024.02 |
| 대상 | RDC 동탄센터 SSG 1DAY 배송 서비스 |
| 목표 | 이동평균 기반 예측에서 ML 기반 예측으로 전환 |
| 기술 스택 | Scala, Python, PySpark, Ray, Apache Airflow |

---
## 2. 배경 및 필요성

기존 자동발주 파이프라인은 **이동평균 기반 예측 로직**으로, 다양한 SKU의 수요 패턴을 반영하기 어려웠습니다.

특히 **저빈도 SKU(롱테일)** 나 **이벤트성 판매 상품**은 단순 평균 모델로는 과소예측(Under-forecasting) 문제가 발생했습니다.

이에 따라 다음 세 가지 목표를 설정했습니다.

1. **SKU 단위 ML 예측 모델링**으로 세분화된 수요 패턴 반영
2. **베이지안 최적화 기반 모델 선택 로직**으로 최적 알고리즘 자동화
3. **Airflow 배치 파이프라인**으로 학습 및 예측 스케줄링 자동화

---

## 3. 모델링 구조

### 3.1 학습 대상 단위
- 영업점 x SKU 단위로 모델 독립 학습
- 시계열 특성을 반영하기 위해 최근 **8주 간 데이터 윈도우** 기반 학습

### 3.2 사용 모델

| 계열       | 모델명 | 설명 |
|----------|---------|------|
| Tree 기반  | XGBoost, LightGBM, RandomForest | 비선형 트렌드 및 피처 간 상호작용 반영 |
| 선형 회귀 기반 | Ridge, Lasso, ElasticNet | 가벼운 베이스라인 및 다중공선성 완화용 |

> - 베이지안 최적화 과정에서 계산된 MAE를 이용해 SKU별 모델을 자동 선택함.
> - 각 모델은 `nRMSE`, `nMAE`, `MAPE`, `SMAPE` 지표로 사후 성능 검증하는 방식으로 모니터링. 

---

## 4. 모델 선택 로직 (Bayesian Optimization 기반)

기존에는 모든 SKU에 동일한 알고리즘(이동평균 계산방식)을 적용했으나, 본 프로젝트에서는 각 SKU의 데이터 특성에 따라 **최적 하이퍼파라미터 + 모델 유형**을 자동 선택하도록 개선했습니다.

### 베이지안 최적화 과정

1. 모델 후보군 정의  
   $ M = \{XGB, LGBM, RF, Ridge, Lasso, ElasticNet\} $
2. 하이퍼파라미터 탐색 공간 설정  
   (예: `alpha`, `learning_rate`, `max_depth`, `lambda_l1`, `lambda_l2`, 등)
3. Validation 세트에서의 오차 최소화 목적함수 설정  


   $$ 
   \min_{m \in M, \theta_m} \; \text{MAE}_{val}(m(\theta_m))
   $$


4. Gaussian Process 기반 탐색으로 최적 $ (m^*, \theta^*) $ 탐색
5. SKU별로 최적 모델 저장 및 후속 예측 단계에 반영

---
## 5. 파이프라인 구성

### 5.1 학습 파이프라인 (주간)
- Airflow 주간 배치
- Ray Cluster 병렬 분산 학습
- Validation 기반 베이지안 최적화 수행
- SKU별 모델 저장 및 GCS 업로드

### 5.2 예측 파이프라인 (일간)
- Airflow 일간 배치
- 전일 데이터 적재 -> 예측 수행 -> 결과 저장
- 예측 결과 협업 부서 DB IF

---
## 6. 성능 요약

- 출하량 그룹 별 성능 상이하나, 내부 기준 top-head SKU의 경우 sMAPE 약 61% 수준 유지 (오픈 후 3개월)

---
## 7. 회고 및 한계점

### 7.1 개선한 점
- 모델 자동 선택 로직(Bayesian Optimization) 을 적용함으로써, 이동평균 기반 예측 대비 예측 성능을 개선했습니다.
- Ray 기반 병렬화를 이용해, 글로벌 학습 대비 학습 속도를 개선하여 1주 단위 학습을 현실적으로 운영 가능하게 했습니다.

### 7.2 한계점

#### 7.2.1 모델 선택과 일반화 오차의 불일치
- 베이지안 최적화는 주어진 Validation set에서의 성능을 최대화하도록 탐색합니다.
- 하지만 SKU별 데이터가 희소하거나 간헐적인 경우, Validation 세트가 전체 분포를 대표하지 못해 **일반화 오차(Generalization Error)** 가 왜곡될 여지가 있습니다.
- 즉, **Validation 성능이 가장 좋은 모델이 실제 예측에서 항상 최적일 보장은 없습니다.**
> **예시:**
> - 특정 SKU가 일시적으로 이벤트성 수요를 겪을 경우
> - XGBoost는 이를 과적합(overfitting)하는 반면
> - Ridge 모델은 안정적인 예측을 보이는 현상이 관찰됨.

---

#### 7.2.2 모델 탐색 공간의 불균형

- 트리 기반 모델(XGB, LGBM, RF)은 하이퍼파라미터 차원이 높고, 선형 모델(Ridge, Lasso, ElasticNet)은 단일 파라미터(`alpha`) 중심으로 단순합니다.
- 따라서, 동일한 탐색 횟수 내에서 트리 계열 모델이 상대적으로 불리하거나, 반대로 초기 샘플링이 좋을 경우 지나치게 우세해지는 등 **탐색 공간의 불균형**이 결과에 영향을 줄 수 있을 것 같습니다.
- 또한, $ \operatorname{argmin} (MAE) $ 만이 모델 선택의 기준이 되어, 주차 별로 모델이 변경됨에 따른 예측 성능의 일관성 저해 가능성이 존재합니다. 

---
### 7.3 최종 회고
- 본 프로젝트의 베이지안 최적화 기반 모델 선택은 **운영 효율을 끌어올렸다는 점에서 실무적으로는 성공적**이었습니다.
- 그러나 **이론적 관점에서 "최적 모델을 찾는 과정"과 "일반화 성능을 보장하는 과정"은 별개**의 문제입니다.
- 향후에는 Validation 기반 단일 선택보다, **앙상블 가중치 기반 또는 불확실성 반영형 모델 선택 체계**로 개선해보는 것이 좋겠습니다.
