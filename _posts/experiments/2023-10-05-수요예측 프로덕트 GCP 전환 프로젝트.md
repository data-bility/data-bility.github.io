---
title: 수요예측 프로덕트 GCP 전환 프로젝트
date: 2023-09-15 00:00:00 +09:00
categories: [experiments]
math: false
---
> **한 줄 요약**  
> - 온프렘 환경에서 운영되던 **수요예측 프로덕트 전체 파이프라인을 GCP(BigQuery, GCS, Airflow)** 기반으로 전환  
> - 데이터 저장소, 워크플로우, 코드, 배포 과정을 클라우드 친화적으로 리팩터링했습니다.

---
## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| 기간 | 2023.08 ~ 2023.09 |
| 대상 | 수요예측 프로덕트 전체 (ETL + 학습 + 배치 워크플로우) |
| 목적 | On-Premise -> GCP 전환 및 코드 구조/운영 체계 표준화 |
| 주요 기술 | `GCP`, `GCS`, `BigQuery`, `Scala`, `Spark`, `Airflow`, `GitLab` |

---
## 2. 추진 배경

기존 수요예측 파이프라인은 **On-Premise Hadoop & MySQL** 환경에서 운영되며 다음과 같은 한계를 보였습니다.

- 고정 리소스 기반의 **확장성 부족**
- **MySQL 저장 용량 한계**로 장기 이력 보존 어려움
- **Azkaban 스케줄러**의 운영 모니터링 제약
- **Scala/Python 혼합 코드**로 인한 유지보수 복잡성

이에 따라, **데이터 저장소부터 워크플로우, 코드 관리, CI/CD**까지 전반적인 **클라우드 전환**을 목표로 프로젝트를 진행했습니다.

---
## 3. 주요 개선 항목

### 3.1 On-Premise -> GCS 전환

#### 개요
- Hadoop HDFS 기반의 원천 데이터를 **GCS(Google Cloud Storage)** 로 이관
- **MySQL -> BigQuery** 전환을 통해 대용량 테이블 처리 및 관리 효율화

#### 진행 과정
1. 기존 HDFS Parquet 테이블의 **스키마 매핑 및 파티션 구조 재설계**
2. GCS 적재 후 **전후 데이터 정합성 검증 및 샘플링 비교**
3. BigQuery 상에서 **품질 모니터링 쿼리 자동화**
4. ML 학습 스크립트에서 BigQuery API 직접 연동으로 구조 단순화

#### 기술 스택
`GCP`, `GCS`, `BigQuery`

---

### 3.2 프로덕트 레거시 코드 리팩터링

#### 개요
Scala와 Python으로 구성된 기존 코드의 구조와 스타일을 통일하고, 협업 중심의 Git 운영 체계를 정립했습니다.

#### 주요 내용
1. **코드 스타일 가이드 정립**
  - Scala, Python 공통 Naming Rule / 함수 구조화 / 예외 처리 방식 표준화
2. **Git Commit Convention 논의/도입**
   ```text
   [type]: [scope] - [description]
   ex) feat: model - add weighted MAE evaluation metric
   ```
3. **리뷰 체계 개선**
- Merge Request 템플릿 도입
- Pre-commit Hook 기반 Lint 및 Static Check 자동화

#### 기술 스택
`Scala`, `Spark`, `GitLab`

---

### 3.3 Azkaban -> Airflow 전환

#### 개요
Azkaban 기반 배치 워크플로우를 Airflow DAG 구조로 전환하여  
의존성 관리, 모니터링, CI/CD 자동화를 강화했습니다.

#### 과정 요약
1. Azkaban Job을 Airflow DAG로 이관
2. SSHOperator 등으로 DAG 재작성
3. Git Commit -> DAG 자동 반영되는 CI/CD 파이프라인 설계

#### 성과
- 레거시 배치 Azkaban -> Airflow 전환
- Git Commit 시 Batch Task 자동 반영 구조 완성
- 모니터링 및 장애 대응 시간 약 30% 단축

#### 기술 스택
Scala, Spark, Apache Airflow, Python

---
## 4. CI/CD 파이프라인 구조

다음은 GitLab 기반 CI/CD 파이프라인의 전체 흐름을 단순화한 구조입니다.<br>
* GitLab Commit / Merge <br>
│ <br>
▼ <br>
* Code Lint / Test / Static Check <br>
│ <br>
▼ <br>
* GitLab CI Build Pipeline <br>
│ <br>
▼ <br>
* GCS Script Sync -> Airflow DAG Deploy <br>
│ <br>
▼ <br>
* DAG Trigger -> Execution Log Push
---

## 5. 결과 요약

| 구분 | 개선 내용                            | 주요 성과 |
|------|----------------------------------|-----------|
| 데이터 저장소 | Hadoop -> GCS / MySQL -> BigQuery | 확장성 및 쿼리 효율 향상 |
| 워크플로우 | Azkaban -> Airflow                 | DAG 단위 제어 및 모니터링 강화 |
| 코드 품질 | Scala/Python 리팩터링                | 유지보수성 및 협업 효율 개선 |
| 배포 프로세스 | GitLab CI/CD                     | Commit-to-Deploy 자동화 구축 |

---

## 6. 인사이트

- **데이터 계층 구조**를 먼저 표준화해야 전환 리스크를 최소화할 수 있다.
- 코드 리팩터링과 인프라 이관을 병행할 때 생산성 향상 폭이 크다<br>(고생하는 김에 하자...)
- **Airflow + Git Commit 자동 반영 구조**는 DevOps 효율을 향상시킨다.
