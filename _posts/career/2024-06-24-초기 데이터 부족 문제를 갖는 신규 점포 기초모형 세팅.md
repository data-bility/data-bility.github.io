---
title: 초기 데이터 부족 문제를 갖는 신규 점포 기초모형 세팅
date: 2024-06-24 00:00:00 +09:00
categories: [career]
math: true
---

## 1. 문제 상황: 신규 점포의 데이터 부족과 초기 예측 세팅
본 게시글에서는 아직 모델을 학습시키기엔 데이터가 부족하고, 그렇다고 예측을 포기할 수도 없는 상황을 다뤄봅니다. <br>

> - 신규 오픈한 점포나, 신상품의 경우에는 과거 데이터가 충분하지 않아 안정적인 수요예측 모델을 학습시키기 어렵습니다.
> - 이 문제는 일종의 cold-start 문제라고도 볼 수 있습니다.


| 구분 | 기초 예측 모형 | 주요 특징 |
|------|----------------|------------|
| 1 | 30일 이동평균(Moving Average) | 단순하지만 안정적인 baseline |
| 2 | 30일 요일평균(Day-of-Week Mean) | 주기성 반영 가능 |
| 3 | ARIMA | 단변량 시계열 기반의 계절성 반영 |


운영 레거시를 참고하여서, 위 표와 같이 세 가지 기초 예측 모형을 사용하여 상품 별 예측값을 모두 계산했습니다. <br>
이어서 Demand Classification 결과에 따라, 각 SKU에 적합한 예측모형을 자동 선택하도록 초기 세팅을 구성하려 했습니다. <br>  
문제는, 해당 점포의 서비스 초기부터 운영 대상 SKU가 제법 많았고, 신상품을 분류할 수 있는 라벨 데이터가 없는 상태라서 예측 성능 관점에서 적절한 크기의 `window size`를 부여하기에 데이터적으로 어려운 상황이었다는 것입니다.<br>

**고정된 Window size(30일)** 을 사용하는 것에는 구체적으로 다음과 같은 문제가 있었습니다.
- 갑작스러운 수요 급증 구간에서 예측값이 따라가지 못함
- 장기적인 추세 변화에 대한 반응이 지나치게 느림
- 신규 상품의 경우 30일 데이터조차 확보되지 않아 모델이 불안정하고, 최소 size를 지정해줘야함.

> 요약 : 이러한 문제 상황은 **Window size selection** 문제를 일으켰고, **data drift**(분포 변화)에 민감한 구조적 한계를 드러냈습니다.


---

## 2. 접근 방향: Time Series Segmentation 기반의 Demand Classification

본 과제의 목표는 **기초 수요예측 모형의 예측 성능을 높이는 것**이 되었습니다.  


이를 위해 먼저, 시계열의 구조적 변화를 반영할 수 있는 `Change Point Detection`과 `Window Size Selection` 문제를 함께 다루기로 했습니다.

### 2.1 Change Points 탐지

> - y(t)의 평균과 분산이 시간에 따라 바뀌는 경우, 단변량 예측모형의 성능은 학습 구간의 시작 시점에 크게 의존하게 됩니다.  
> - 따라서, data drift가 발생하는 구간을 탐지하고 해당 구간 이후의 데이터만을 사용하면 더 나은 예측을 기대할 수 있습니다.

Change Point는 다음과 같은 신호를 기반으로 탐지할 수 있습니다:
- 관심 `feature`가 0이 되는 시점
- 외생 피처 값의 급격한 변동  

이를 통해 단변량 예측모형이 놓치기 쉬운 구조적 변화에 대응할 수 있으리라 기대했습니다.


### 2.2 Window Size 선택

> Change Point를 탐지한 이후, "얼마만큼의 기간"을 학습에 사용할지도 중요한 결정 요인이 되었습니다.

연구 동향을 살펴보면 다음과 같은 방식이 사용됩니다:
- 일정 기간 이상의 window 중, 자기상관계수(ACF)가 가장 높은 구간 선택
- 주기적 패턴(푸리에 계수 등)을 기준으로 하는 주기 선택
- 비지도 학습 기반의 최적 segmentation

다만 실제 적용에서는 다음 케이스의 SKU가 존재하기 때문에 SKU별 최소 데이터 보유 기간, 품목 특성 등을 고려해 **규칙 기반 처리**를 일부 병행할 필요도 있었습니다. <br>


<img src="/assets/img/issue_type_SKU.png" width="1000px" height="230" alt="issue_type_SKU example">

---

## 3. 첫번째 시도: ClaSP 라이브러리를 활용한 자동 Window & Change Point 탐지

> - Python 기반 라이브러리 [ClaSP (Clustering-based Segmentation)](https://github.com/ermshaua/claspy) 를 도입하여 Change Point와 Window Size를 동시에 계산하는 접근을 시도했습니다.


ClaSP 라이브러리는 다음 두 가지 기능을 제공합니다:

- Change Point Detection : 실제 변화 지점을 기준으로 예측된 변화 지점을 계산
- Window Size Selection : 다양한 알고리즘 기반의 최적 구간 탐색 지원


<img src="/assets/img/ClaSP example.png" width="800px" height="450" alt="ClaSP example">


이진화된 신호 형태의 피처들을 입력값으로 사용하면 단변량 모델의 정보 손실을 줄일 수 있다는 장점이 있었습니다. <br>
그러나, **ClaSP만으로는 예측 성능 개선이 제한적**이었습니다.

이유는 다음과 같습니다:
- 점포별 데이터의 분포 변화가 예상보다도 더 불규칙적이었음
- 변동 폭이 큰 SKU의 경우 탐지된 change point가 과도하게 많거나, 의미 없는 구간으로 분리됨
- 모델의 선택 로직과 연동이 어려움 (즉, 예측보다는 segmentation에 초점)

## 4. 두번째 시도: 사후 평가(Post-Hoc Evaluation) 기반의 Model Selection

### 4.1 절차
> 상기 한계를 보완하기 위해, **사후 평가 기반 모델 선택 방법**으로 방향을 전환했습니다.

구체적인 절차는 다음과 같습니다.

1. **매주 월요일**을 기준으로, 직전 주 **월~일** 구간의 실제 수요(`y`)와 세 가지 모델(30일 이동평균, 30일 요일평균, ARIMA)의 예측값(`ŷ`)을 비교함.
2. 세 모델 중, **SMAPE가 가장 낮은 모델**을 1차로 선택함.
3. SMAPE가 동일하거나 근소 차이(예: 0.2%p 이내)일 때는 **MAE가 더 낮은 모델**을 최종 선택함.
4. 이렇게 선택된 모델은 이후 **한 주간**의 예측에만 사용하고, 다음 주 동일 절차를 반복함.

즉, 모델을 “사전에 고정”하기보다, **SMAPE → MAE**의 우선순위를 적용한 **사후 성능 평가 기반 주간 교체** 구조입니다.

이 방식은 신규 점포나 데이터가 불안정한 시점에서 다음 이점을 보였습니다.
- **분모 효과 완화와 대칭적 처벌(SMAPE):** 0 또는 소량 수요 구간이 많은 초기 데이터에서 MAPE가 폭주하는 문제를 줄이고, **과소·과대 예측을 대칭적으로** 다룸.
- **절대 오차 안정성(MAE):** 단위 기준의 절대 오차를 최소화하여, **실제 물량 단위의 과소·과대 오차**를 보수적으로 억제함.
- **빠른 적응:** 주간 단위로 모델을 교체해 **갑작스러운 변동**에도 추종성이 향상됨.


### 4.2 왜 SMAPE, MAE가 기준이었는가?
> 요약: SMAPE로 **상대적·대칭적 오류 구조**를 우선 통제하고, MAE로 **절대 물량 기준의 안정성**을 보완하고자 정책을 결정했습니다.<br>
> 이는 초기 신규 점포에서 흔한 **과소/과대 예측의 균형 붕괴**를 줄이는 현실적 타협이었습니다.


이것은 기본적으로 과소/과대 예측 관점의 성능 개선이 팀 내부 목표가 되었기 때문입니다. <br>
각 지표의 수식과 특징을 살펴보면 이러한 선택의 이유를 엿볼 수 있습니다. : 

- **SMAPE(대칭 MAPE)**  



  $$
  \text{SMAPE} = \frac{2}{n}\sum_{t=1}^{n}\frac{|\,\hat{y}_t - y_t\,|}{|y_t| + |\hat{y}_t| + \varepsilon}
  $$




  - SMAPE은 MAPE 대비 **저수요·0수요 구간에서의 분모 폭주** 문제를 완화함.
  - 분모가 $ |y| + |\hat{y}| $ 이므로 **과소/과대 예측을 균형 있게 처벌**함 <br>
(= 초기 점포가 갖는 zero-inflated 분포에서 **과대 예측 penalty만 과도**해지는 현상을 줄임.)
  - $\epsilon$을(예: $1e{-6}$) 두어 0/0, 0 분모 케이스를 방지함.


- **MAE(절대 오차 평균)**


  $$
  \text{MAE} = \frac{1}{n}\sum_{t=1}^{n}|\,\hat{y}_t - y_t\,|
  $$



  - SKU 별 **실제 물량 단위**의 오차 크기를 직접적으로 관리함.
  - SMAPE이 거의 유사한 모델 간에서는, **실제 운영 영향(언더/오버 피킹, 재고 변동)** 을 직관적으로 더 작게 만드는 모델을 고르도록 함.
  - 또한, Window size 또는 SKU 별 데이터에 따라 SMAPE이 계산될 수 없는 경우가 있으므로 이러한 한계점을 보완함.


---

## 5. 한계점 및 회고

물론, 이 방식에도 명확한 한계가 존재했습니다.

- **사후 평가 시점의 지연:** 실시간 대응에는 부적합.
- **모델 간 불연속성:** 주간마다 모델이 바뀌어 예측값의 연속성이 떨어질 수 있음.

하지만 신규 점포가 갖는 데이터 환경에서는, "완벽한 모델"보다 "지속적으로 적응하는 구조"가 더 중요했습니다.


`Change Point Detection`이나 `Window Size Selection`과 같은 정적 방법론은 분포 변화가 극심한 초기 점포 데이터에는 한계가 있었지만,
사후 평가 기반의 모델 선택 방법은 데이터의 질적 변화를 감지하고, 이를 모델 선택으로 반영하는 **동적 피드백 루프**를 제공했다고 생각합니다.

따라서, 수요 변동성이 높은 신규 점포 환경에서의 baseline 전략으로서 의미가 있었습니다. 또한 이 접근은 향후 ML/DL 기반 수요예측 모델에서도 활용 가능한 방법으로 예상합니다.
