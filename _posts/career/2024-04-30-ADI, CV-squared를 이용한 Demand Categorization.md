---
title: ADI, CV-squared를 이용한 Demand Categorization
date: 2024-04-30 00:00:00 +09:00
categories: [career]
math: true
---

## 1. 기본 개념
> 점포/SKU 단위의 수요예측에서는, **수요 데이터의 발생 패턴**을 구분하여 적합한 모델을 적용하는 것이 예측성능의 관점에서 유리할 수 있습니다.<br>
특히 **간헐적(intermittent)** 또는 **불규칙(irregular)** 수요를 포함하는 경우, SKU별로 모델링 전략이 달라져야 합니다.  
이를 위해 대표적인 통계적 분류 기준으로 **ADI(Average Demand Interval)** 과 **CV²(Coefficient of Variation Squared)** 를 사용합니다.

### 1.1 ADI(Average Demand Interval) 

- ADI는 그 이름 그대로 수요가 발생하는 `평균 간격`을 의미합니다. 즉, 특정 점포/SKU가 얼마나 자주 팔리는지를 나타내는 지표입니다.

$$
ADI = \frac{N}{N_{nx}}
$$

  - $N$ : 전체 기간 수 (예 : 상품 운영 기간 총 30일, 52주 등) 
  - $N_{nx}$ : 수요가 0이 아닌 기간 수 (예 : 상품 운영 중 판매가 발생한 일 수 총 12일, 27주 등)


| SKU | 전체 기간 N | 수요 발생 횟수 N_nx | ADI |
|------|---------|---------------|------|
| A | 30      | 30            | 1.00 |
| B | 30      | 10            | 3.00 |
| C | 30      | 3             | 10.00 |


- 상기 표의 예시처럼, ADI 가 높을수록, 즉 수요 발생 간격이 클수록 SKU는 `간헐적 수요 패턴`을 갖게 됩니다.

### 1.2 Coefficient of Variation Squared ($CV^2$)
- $CV^2$는 수요 발생량의 불규칙성을 측정하는 지표입니다.

$$
CV^2=\left(\frac{\sigma_d}{\mu_d}\right)^2
$$

  - $\sigma_d$ : 수요의 표준편차
  - $\mu_d$ : 수요의 평균
  - 단, 이때의 수요 $d > 0$

수요 패턴 분류에서 변동계수가 아닌, 그 제곱을 사용한 이유는 무엇일까? 하는 의문이 있을 수 있습니다. <br>
처음으로 ADI, CV-squared를 이용해 수요 패턴을 분류한 것은 아래 논문인데요. <br>
> Syntetos, A. A., Boylan, J. E., & Croston, J. D. (2005). On the categorization of demand patterns. <br>
> Journal of the Operational Research Society, 56(5), 495–503. https://doi.org/10.1057/palgrave.jors.2601841 <br>

해당 논문에서 여러 예측방법들의 기대 MSE 비교에서 유도된 경계식과 실제 간헐 패턴의 시계열 데이터 검증으로 정당화 되는 내용을 담고 있습니다. <br>
실증적 관찰 관점에서 쓰여진 논문이라, 그 외의 근거는 제시되지 않지만 개인적으로는 다음과 같이 추측합니다.
- $CV$는 스케일 처리한 편차, 즉 표본집단 간 편차를 비교하기 위한 지표이다. 연구자들은 편차보다는, 일종의 분산 형태를 띠는 지표를 만들고 싶었던 것 같다.
- 왜냐하면, 아래 예시와 같이 변동성의 증가폭이 눈에 더 잘 띄는 것은 $CV$가 아닌 $CV^2$이기 때문이다.
  
  | SKU | 평균 μ | 표준편차 σ | CV  | CV²  |
  | --- | ---- | ------ | --- | ---- |
  | A   | 100  | 10     | 0.1 | 0.01 |
  | B   | 100  | 30     | 0.3 | 0.09 |
  | C   | 100  | 60     | 0.6 | 0.36 |

---
## 2. 수요 패턴 분류

| 구분 | ADI 기준 | CV² 기준 | 특징 |
|------|-----------|-----------|------|
| **Smooth** | ≤ 1.32 | ≤ 0.49 | 수요가 규칙적이며 안정적 |
| **Intermittent** | > 1.32 | ≤ 0.49 | 드물지만 일정한 수요 |
| **Lumpy** | > 1.32 | > 0.49 | 간헐적이고 불규칙한 수요 |
| **Erratic** | ≤ 1.32 | > 0.49 | 수요 간격은 짧지만 변동성이 큼 |



> **요약**
> - 앞서 밝혔듯, 위 표의 기준값은 이론적이라기보다는 실증적인 근거를 갖고 있으며, 각 지표는 아래와 같은 특징을 잡아내기 위해 사용됩니다.
> - ADI는 *발생 빈도* (얼마나 자주 발생하는가)
> - CV²는 *규모의 불규칙성* (발생 시 얼마나 불안정한가)

---

## 3. PySpark 구현 예시
```python
from pyspark.sql import functions as F
def classify_demand(df, group_cols=("STR_ID", "SKU_ID")):
    df_agg = (
        df.groupBy(*group_cols)
          .agg(
              F.count("*").alias("N"),
              F.sum(F.when(F.col("y") > 0, 1).otherwise(0)).alias("N_nz"),
              F.mean(F.when(F.col("y") > 0, F.col("y"))).alias("mean_d"),
              F.stddev(F.when(F.col("y") > 0, F.col("y"))).alias("std_d")
          )
          .withColumn("ADI", F.col("N") / F.col("N_nz"))
          .withColumn("CV2", (F.col("std_d") / F.col("mean_d")) ** 2)
          .withColumn(
              "demand_type",
              F.when((F.col("ADI") <= 1.32) & (F.col("CV2") <= 0.49), "Smooth")
               .when((F.col("ADI") <= 1.32) & (F.col("CV2") > 0.49), "Erratic")
               .when((F.col("ADI") > 1.32) & (F.col("CV2") <= 0.49), "Intermittent")
               .otherwise("Lumpy")
          )
    )
    return df_agg.select(*group_cols, "ADI", "CV-squared", "demand_pattern")
```
---

## 4. 응용 : 수요 패턴 분류에 따른 모델 후보 탐색

| 수요유형 | 목적                | 예시 모델                 |
|---------|-------------------|-----------------------|
| Smooth | 트렌드·계절성 반영        | ARIMA, ETS            |
| Intermittent | 수요 발생 확률 예측       | Ridge, LightGBM       |
| Lumpy | 0-Inflated 데이터 대응 | Croston method        |
| Erratic | 불규칙 변동성 학습        | Zero-Inflated XGBoost |



> 주의 : 현재 회사에서 다루고 있는 수요예측 프로덕트가 위와 같은 방식으로 모델을 선택하지는 않습니다. <br>

다만, 상기 예시와 같은 방법으로  **EDA 단계에서 ADI–CV² 분류를 적용하면, 초기 모델 후보군을 직관적으로 좁히는 데 유용**합니다. <br>
특히, 길이가 짧지도 길지도 않은 시계열 데이터를 예측 관점에서 다룰 때 이 방법은 EDA의 첫 단추로 사용하기에 좋았습니다. <br>
모델링 복잡도를 사전에 어느정도 파악할 수 있고, 각 모델의 최적화를 위해 search space를 설계하는 데에도 도움이 됩니다. <br>
실제로는, 위 방법과 기존 레거시 정책 상의 점포/SKU 등급 체계를 복합적으로 활용하여 특정 SKU 집단에 대해 Croston method 가 우선 선택되는 로직을 설계했습니다.

---
## 5. 한계점 및 회고
### 5.1 한계점
(1) **분류 기준의 경험적 한계**
- ADI=1.32, CV²=0.49는 특정 산업(자동차 부품)에서 유도된 값이므로, e-commerce나 일별 판매 데이터에서는 분포 특성이 달라질 수 있습니다.
- 따라서, 본 분석에서는 해당 값을 절대 기준이 아닌 EDA 과정에서의 참고적 cut-off로 활용했습니다.

(2) **정적 통계량의 한계**


<img src="/assets/img/f_type over time.png" width="500px" height="300px" alt="f_type over time example">


- ADI와 $CV^2$는 특정 기간의 통계적 요약값에 불과합니다.
- 프로모션, 시즌성, 가격 변경 등 동적 요인에 의한 패턴 변화는 반영하지 못합니다.
- 이 방식을 개선하여 사용한다면, 향후에는 **rolling window 기반 시점별 패턴 변동 추적** 하는 방식으로 접근해볼 수 있을 것 같습니다. 이러한 방식의 패턴 분류는 각 데이터의 기간, 그리고 시간 흐름에 따라 변동이 있을 수 밖에 없기 때문입니다. 
상기 예시 그림처럼, 어떤 점포에서 판매중인 상품들에 대해 각 시점별로 수요 패턴을 분류해보면 아래와 같이 패턴 별 SKU 수가 변동할 것 입니다.
- 또한, 논문에서 제공한 기준값은 앞서 말한 바와 같이 자동차 부품 산업 데이터에 국한된 것이므로 점포 별 분포 패턴 등의 데이터 특성을 반영하여 적합한 cut-off를 지정해야만 합니다.

(3) **모델 선택으로의 직접적 연결은 아님**
- 본 분류는 EDA 목적의 초기 분류로, 모델 자동 선택 로직에 직접 사용되지는 않습니다.
- 다만, **모델 후보군을 효율적으로 좁히는 보조적인 역할**을 했습니다. 또한, 그 외 기존 정책과 복합적으로 활용하여 특정 패턴을 마이닝할 수 있었습니다.
  (이와 관련하여서는, 추후 Croston method를 포스트에서 다룰 때 언급하도록 하겠습니다.)

### 5.2 회고
> $ADI-CV^2$ 분류는 예측 모델을 직접 결정하는 방법은 아니지만, EDA 관점에서 모델링 난이도를 정성적으로 파악하고 초기 후보군을 설계하는 데 유용한 프레임워크입니다.

이를 통해 다음을 기대할 수 있었습니다.

- (1) SKU별 수요 구조에 대한 직관적 이해
- (2) 탐색적 모델링 방향의 초기 설정
- (3) 비정상, 간헐 패턴을 사전 식별하여 모델링 자원 효율화
